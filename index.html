<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥åº—äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </title>
    <!-- Tailwind CSSã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIFF SDKã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://static.line-scdn.net/liff/2.22.3/liff.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
            margin: 0;
            padding: 0;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚³ãƒ³ãƒ†ãƒŠè¨­å®š */
        .mobile-container {
            max-width: 450px;
            min-height: 100vh;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
        }

        .step-section {
            background-color: #ffffff;
            border-radius: 1.25rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ©ã‚¸ã‚ª/ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-radio-label {
            display: block;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #f9fafb;
            margin-bottom: 0.75rem;
            /* ã‚°ãƒªãƒƒãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
            display: grid;
            grid-template-columns: 32px 1fr auto;
            align-items: center;
            gap: 1rem;
        }

        .custom-radio-label:hover {
            background-color: #f3f4f6;
        }

        input[type="radio"]:checked+.custom-radio-label {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 0 2px #93c5fd;
        }

        /* ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ€ãƒŸãƒ¼ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
        .icon-placeholder {
            width: 32px;
            height: 32px;
            background-color: #bfdbfe;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1d4ed8;
            font-weight: bold;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        /* æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« (Step 4) - ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹å‘ä¸Š */
        .time-slot-label {
            display: block;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #ffffff;
            font-weight: 500;
        }

        .time-slot-label:hover {
            background-color: #f3f4f6;
        }

        input[type="radio"].time-radio:checked+.time-slot-label {
            background-color: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #93c5fd;
        }

        .time-radio:disabled+.time-slot-label {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            border-color: #e5e7eb;
            box-shadow: none;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        #footer-nav {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem 1.5rem;
            background-color: #ffffff;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05), 0 -2px 4px -1px rgba(0, 0, 0, 0.03);
            z-index: 10;
        }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-bar-container {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #3b82f6;
            border-radius: 4px;
            transition: width 0.3s ease-in-out;
        }

        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .input-error {
            border-color: #ef4444 !important;
        }

    </style>
</head>

<body class="bg-gray-100">
    <div class="mobile-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="p-4 text-center border-b border-gray-200 bg-white">
            <h1 class="text-xl font-bold text-gray-800">æ¥åº—äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </h1>
            <p id="liff-status" class="text-xs text-gray-500 mt-1">LIFFåˆæœŸåŒ–ä¸­...</p>
        </header>

        <main class="flex-grow p-4 pt-6">
            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="message-area" class="hidden"></div>

            <!-- ============================================== -->
            <!-- Step 1: ã”äºˆç´„å†…å®¹ (å¿…é ˆ) -->
            <!-- ============================================== -->
            <section id="step-1" class="step-section">
                <h2 class="text-lg font-semibold mb-4 text-blue-600">Step 1. ã”äºˆç´„å†…å®¹ã‚’é¸æŠ</h2>
                <div class="space-y-3">
                    <!-- æŒ¯è¢–ï¼ˆã”è³¼å…¥ï¼‰ -->
                    <div>
                        <input type="radio" id="menu-1" name="reservation-menu" value="æŒ¯è¢–ï¼ˆã”è³¼å…¥ï¼‰" class="hidden" onchange="updateFormData('reservationMenu', this.value); validateStep1();">
                        <label for="menu-1" class="custom-radio-label">
                            <div class="icon-placeholder">ğŸ‘˜</div>
                            <span class="font-medium text-gray-800">æŒ¯è¢–ï¼ˆã”è³¼å…¥ï¼‰</span>
                            <svg class="h-5 w-5 text-blue-600 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <circle cx="12" cy="12" r="10" stroke-width="2" class="text-gray-300"></circle>
                                <path d="M9 12l2 2 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden checked-icon"></path>
                            </svg>
                        </label>
                    </div>
                    <!-- æŒ¯è¢–ï¼ˆãƒ¬ãƒ³ã‚¿ãƒ«ï¼‰ -->
                    <div>
                        <input type="radio" id="menu-2" name="reservation-menu" value="æŒ¯è¢–ï¼ˆãƒ¬ãƒ³ã‚¿ãƒ«ï¼‰" class="hidden" onchange="updateFormData('reservationMenu', this.value); validateStep1();">
                        <label for="menu-2" class="custom-radio-label">
                            <div class="icon-placeholder">ğŸŒ¸</div>
                            <span class="font-medium text-gray-800">æŒ¯è¢–ï¼ˆãƒ¬ãƒ³ã‚¿ãƒ«ï¼‰</span>
                            <svg class="h-5 w-5 text-blue-600 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <circle cx="12" cy="12" r="10" stroke-width="2" class="text-gray-300"></circle>
                                <path d="M9 12l2 2 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden checked-icon"></path>
                            </svg>
                        </label>
                    </div>
                    <!-- å’æ¥­è¢´ï¼ˆä¸€å¼ãƒ¬ãƒ³ã‚¿ãƒ«ï¼‰ - é›»è©±èª˜å°ãŒå¿…è¦ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                    <div>
                        <input type="radio" id="menu-3" name="reservation-menu" value="å’æ¥­è¢´ï¼ˆä¸€å¼ãƒ¬ãƒ³ã‚¿ãƒ«ï¼‰" class="hidden" onchange="updateFormData('reservationMenu', this.value); validateStep1();">
                        <label for="menu-3" class="custom-radio-label">
                            <div class="icon-placeholder">ğŸ“</div>
                            <span class="font-medium text-gray-800">å’æ¥­è¢´ï¼ˆä¸€å¼ãƒ¬ãƒ³ã‚¿ãƒ«ï¼‰</span>
                            <svg class="h-5 w-5 text-blue-600 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <circle cx="12" cy="12" r="10" stroke-width="2" class="text-gray-300"></circle>
                                <path d="M9 12l2 2 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden checked-icon"></path>
                            </svg>
                        </label>
                    </div>
                    <!-- æŒ¯è¢–ãƒ¬ãƒ³ã‚¿ãƒ«è€…ï¼ˆå’æ¥­è¢´ï¼‰ - é›»è©±èª˜å°ãŒå¿…è¦ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                    <div>
                        <input type="radio" id="menu-4" name="reservation-menu" value="æŒ¯è¢–ãƒ¬ãƒ³ã‚¿ãƒ«è€…ï¼ˆå’æ¥­è¢´ï¼‰" class="hidden" onchange="updateFormData('reservationMenu', this.value); validateStep1();">
                        <label for="menu-4" class="custom-radio-label">
                            <div class="icon-placeholder">ğŸ€</div>
                            <span class="font-medium text-gray-800">æŒ¯è¢–ãƒ¬ãƒ³ã‚¿ãƒ«è€…ï¼ˆå’æ¥­è¢´ï¼‰</span>
                            <svg class="h-5 w-5 text-blue-600 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <circle cx="12" cy="12" r="10" stroke-width="2" class="text-gray-300"></circle>
                                <path d="M9 12l2 2 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden checked-icon"></path>
                            </svg>
                        </label>
                    </div>
                </div>
                <div id="step-1-error" class="error-message">ã”äºˆç´„å†…å®¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
            </section>

            <!-- ============================================== -->
            <!-- Step 2: åº—èˆ—ã‚’é¸æŠ (å¿…é ˆ) -->
            <!-- ============================================== -->
            <section id="step-2" class="step-section hidden">
                <h2 class="text-lg font-semibold mb-4 text-blue-600">Step 2. ã”å¸Œæœ›ã®åº—èˆ—ã‚’é¸æŠ</h2>
                <div class="space-y-3">
                    <div>
                        <input type="radio" id="store-1" name="store" value="æœ¬åº—" class="hidden" onchange="updateFormData('store', this.value); validateStep2();">
                        <label for="store-1" class="custom-radio-label">
                            <span class="font-medium text-gray-800">æœ¬åº—</span>
                            <span class="text-sm text-gray-500">ã€‡ã€‡çœŒã€‡ã€‡å¸‚ã€‡ã€‡</span>
                        </label>
                    </div>
                    <div>
                        <input type="radio" id="store-2" name="store" value="æ”¯åº—" class="hidden" onchange="updateFormData('store', this.value); validateStep2();">
                        <label for="store-2" class="custom-radio-label">
                            <span class="font-medium text-gray-800">æ”¯åº—</span>
                            <span class="text-sm text-gray-500">ã€‡ã€‡çœŒã€‡ã€‡å¸‚ã€‡ã€‡</span>
                        </label>
                    </div>
                </div>
                <div id="step-2-error" class="error-message">åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
            </section>

            <!-- ============================================== -->
            <!-- Step 3: æ—¥ä»˜ã‚’é¸æŠ (å¿…é ˆ) -->
            <!-- ============================================== -->
            <section id="step-3" class="step-section hidden">
                <h2 class="text-lg font-semibold mb-4 text-blue-600">Step 3. ã”å¸Œæœ›ã®æ—¥ä»˜ã‚’é¸æŠ</h2>
                <label for="reservationDate" class="block text-sm font-medium text-gray-700 mb-2">æ—¥ä»˜</label>
                <input type="date" id="reservationDate" name="reservationDate" min="" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="updateFormData('reservationDate', this.value); validateStep3(); generateTimeSlots();">
                <div id="step-3-error" class="error-message">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
                <p class="text-sm text-gray-500 mt-2">â€»æœ¬æ—¥ã‚ˆã‚Š2æ—¥å¾Œã‹ã‚‰äºˆç´„å¯èƒ½ã§ã™ã€‚</p>
            </section>

            <!-- ============================================== -->
            <!-- Step 4: æ™‚é–“ã‚’é¸æŠ (å¿…é ˆ) - ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹å‘ä¸Š -->
            <!-- ============================================== -->
            <section id="step-4" class="step-section hidden">
                <h2 class="text-lg font-semibold mb-4 text-blue-600">Step 4. ã”å¸Œæœ›ã®æ™‚é–“ã‚’é¸æŠ</h2>
                <div id="time-slots" class="grid grid-cols-3 gap-3">
                    <!-- æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã¯JavaScriptã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
                <div id="step-4-error" class="error-message">æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
            </section>

            <!-- ============================================== -->
            <!-- Step 5: ãŠå®¢æ§˜æƒ…å ± (å¿…é ˆ) - ç”Ÿå¹´æœˆæ—¥å…¥åŠ›è£œåŠ©ã‚’æ”¹å–„ -->
            <!-- ============================================== -->
            <section id="step-5" class="step-section hidden">
                <h2 class="text-lg font-semibold mb-4 text-blue-600">Step 5. ãŠå®¢æ§˜æƒ…å ±ã‚’å…¥åŠ›</h2>

                <div class="mb-4">
                    <label for="fullName" class="block text-sm font-medium text-gray-700 mb-2">ãŠåå‰ (ãƒ•ãƒ«ãƒãƒ¼ãƒ /å¿…é ˆ)</label>
                    <input type="text" id="fullName" name="fullName" placeholder="ä¾‹: å±±ç”° å¤ªéƒ" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" oninput="updateFormData('fullName', this.value); validateStep5();">
                    <div id="fullName-error" class="error-message">ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
                </div>

                <!-- ç”Ÿå¹´æœˆæ—¥å…¥åŠ›è£œåŠ©ã®æ”¹å–„ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç”Ÿå¹´æœˆæ—¥ (å¿…é ˆ)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <!-- å¹´ -->
                        <select id="birthYear" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="updateBirthDate(); validateStep5();">
                            <option value="">å¹´</option>
                        </select>
                        <!-- æœˆ -->
                        <select id="birthMonth" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="updateBirthDate(); validateStep5();">
                            <option value="">æœˆ</option>
                        </select>
                        <!-- æ—¥ -->
                        <select id="birthDay" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="updateBirthDate(); validateStep5();">
                            <option value="">æ—¥</option>
                        </select>
                    </div>
                    <!-- ç”Ÿå¹´æœˆæ—¥ã®æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ (GASé€ä¿¡ç”¨) -->
                    <input type="hidden" id="birthDate" name="birthDate" onchange="validateStep5()">
                    <div id="birthDate-error" class="error-message">ç”Ÿå¹´æœˆæ—¥ã‚’ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
                </div>

                <div class="mb-4">
                    <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-2">é›»è©±ç•ªå· (ãƒã‚¤ãƒ•ãƒ³ãªã—/å¿…é ˆ)</label>
                    <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="ä¾‹: 09012345678" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" oninput="updateFormData('phoneNumber', this.value); validateStep5();">
                    <div id="phoneNumber-error" class="error-message">æœ‰åŠ¹ãªé›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ãƒã‚¤ãƒ•ãƒ³ãªã—)ã€‚</div>
                </div>

                <div class="mb-4">
                    <label for="emailAddress" class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (ä»»æ„)</label>
                    <input type="email" id="emailAddress" name="emailAddress" placeholder="ä¾‹: example@kasenya.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" oninput="updateFormData('emailAddress', this.value);">
                </div>

                <div class="mb-6">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">å‚™è€ƒæ¬„ (ä»»æ„)</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="ã”è³ªå•ã‚„ã”è¦æœ›ãŒã‚ã‚Œã°ã”è¨˜å…¥ãã ã•ã„ï¼ˆä¾‹ï¼šåŒè¡Œè€…ã®äººæ•°ã€ç‰¹å®šã®æŒ¯è¢–ã®å¸Œæœ›ãªã©ï¼‰" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" oninput="updateFormData('notes', this.value);"></textarea>
                </div>

                <!-- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼åŒæ„ -->
                <div class="flex items-start">
                    <div class="flex items-center h-5">
                        <input id="privacyPolicy" name="privacyPolicy" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded" onchange="updateFormData('privacyPolicy', this.checked); validateStep5();">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="privacyPolicy" class="font-medium text-gray-700">
                            <a href="#" class="text-blue-600 hover:text-blue-700 underline" target="_blank">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã™ã‚‹
                            <span class="text-red-500">*</span>
                        </label>
                    </div>
                </div>
                <div id="privacyPolicy-error" class="error-message">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®åŒæ„ãŒå¿…è¦ã§ã™ã€‚</div>
            </section>

            <!-- ============================================== -->
            <!-- Step 6: ã”æ¥åº—ç‰¹å…¸ (æ¡ä»¶ä»˜ã) - ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«å¼·åŒ–ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ -->
            <!-- ============================================== -->
            <section id="step-6" class="step-section hidden">
                <h2 class="text-lg font-semibold mb-4 text-blue-600">Step 6. ã”æ¥åº—ç‰¹å…¸ã‚’é¸æŠ</h2>
                <p class="text-sm text-gray-600 mb-4">ã€ŒæŒ¯è¢–ï¼ˆã”è³¼å…¥ï¼‰ã€ã¾ãŸã¯ã€ŒæŒ¯è¢–ï¼ˆãƒ¬ãƒ³ã‚¿ãƒ«ï¼‰ã€ã‚’ã”äºˆç´„ã®æ–¹é™å®š</p>

                <div class="space-y-3">
                    <!-- ç‰¹å…¸A -->
                    <div>
                        <input type="radio" id="gift-1" name="gift" value="ç‰¹å…¸A (ã‚«ã‚¿ãƒ­ã‚°ã‚®ãƒ•ãƒˆ)" class="hidden" onchange="updateFormData('gift', this.value); validateStep6();">
                        <label for="gift-1" class="custom-radio-label">
                            <div class="icon-placeholder">ğŸ</div>
                            <span class="font-medium text-gray-800">ç‰¹å…¸A (ã‚«ã‚¿ãƒ­ã‚°ã‚®ãƒ•ãƒˆ)</span>
                        </label>
                    </div>
                    <!-- ç‰¹å…¸B -->
                    <div>
                        <input type="radio" id="gift-2" name="gift" value="ç‰¹å…¸B (ã‚«ãƒ•ã‚§ãƒã‚±ãƒƒãƒˆ)" class="hidden" onchange="updateFormData('gift', this.value); validateStep6();">
                        <label for="gift-2" class="custom-radio-label">
                            <div class="icon-placeholder">â˜•</div>
                            <span class="font-medium text-gray-800">ç‰¹å…¸B (ã‚«ãƒ•ã‚§ãƒã‚±ãƒƒãƒˆ)</span>
                        </label>
                    </div>
                    <!-- ç‰¹å…¸C -->
                    <div>
                        <input type="radio" id="gift-3" name="gift" value="ç‰¹å…¸C (ãã®ä»–)" class="hidden" onchange="updateFormData('gift', this.value); validateStep6();">
                        <label for="gift-3" class="custom-radio-label">
                            <div class="icon-placeholder">âœ¨</div>
                            <span class="font-medium text-gray-800">ç‰¹å…¸C (ãã®ä»–)</span>
                        </label>
                    </div>
                    <!-- ç‰¹å…¸ãªã— -->
                    <div>
                        <input type="radio" id="gift-4" name="gift" value="å¸Œæœ›ã—ãªã„" class="hidden" onchange="updateFormData('gift', this.value); validateStep6();">
                        <label for="gift-4" class="custom-radio-label">
                            <div class="icon-placeholder">ğŸ™…</div>
                            <span class="font-medium text-gray-800">ç‰¹å…¸ã¯å¸Œæœ›ã—ãªã„</span>
                        </label>
                    </div>
                </div>
                <div id="step-6-error" class="error-message">ã”æ¥åº—ç‰¹å…¸ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
            </section>

            <!-- ============================================== -->
            <!-- Step 7: å…¥åŠ›å†…å®¹ã®ç¢ºèª -->
            <!-- ============================================== -->
            <section id="step-7" class="step-section hidden">
                <h2 class="text-lg font-semibold mb-4 text-blue-600">Step 7. å…¥åŠ›å†…å®¹ã®ç¢ºèª</h2>
                <div id="confirmation-details" class="space-y-4 p-4 bg-gray-50 rounded-lg border">
                    <!-- ç¢ºèªå†…å®¹ã¯JSã§å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                </div>
            </section>

            <!-- ============================================== -->
            <!-- Step: å®Œäº†ç”»é¢ -->
            <!-- ============================================== -->
            <section id="step-complete" class="step-section hidden text-center">
                <svg class="h-16 w-16 text-green-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-xl font-bold mb-2 text-gray-800">ã”äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸ</h2>
                <p class="text-gray-600 mb-4">ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚LINEã«ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãŠé€ã‚Šã—ã¾ã—ãŸã€‚</p>
                <p id="complete-message" class="text-lg font-mono text-blue-600 font-semibold hidden"></p>
                <a href="javascript:liff.closeWindow();" class="mt-6 inline-block bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                    LINEã«æˆ»ã‚‹
                </a>
            </section>

            <!-- ============================================== -->
            <!-- Step: é›»è©±äºˆç´„èª˜å°ç”»é¢ -->
            <!-- ============================================== -->
            <section id="step-call" class="step-section hidden text-center p-8 bg-yellow-50 border border-yellow-200">
                <svg class="h-12 w-12 text-yellow-600 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l-2-2m2 2h-8m0 0v8m-4 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-xl font-bold mb-2 text-yellow-700">é›»è©±ã§ã®ã”äºˆç´„ãŒå¿…è¦ã§ã™</h2>
                <p class="text-gray-700 mb-6">
                    é¸æŠã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆ<span id="call-menu-name" class="font-bold text-yellow-800"></span>ï¼‰ã¯ã€äºˆç´„ã®ç‰¹æ€§ä¸Šã€ãŠé›»è©±ã§ã®ã¿æ‰¿ã£ã¦ãŠã‚Šã¾ã™ã€‚
                    ãŠæ‰‹æ•°ã§ã™ãŒã€ä»¥ä¸‹ã®ç•ªå·ã¾ã§ã”é€£çµ¡ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
                </p>
                <a href="tel:0120123456" class="mt-4 inline-block bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 text-lg">
                    <svg class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498A1 1 0 0121 15.72V19a2 2 0 01-2 2h-1C7.82 21 3 16.18 3 10V5z" />
                    </svg>
                    0120-123-456
                </a>
            </section>
        </main>

        <!-- ============================================== -->
        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <!-- ============================================== -->
        <footer id="footer-nav" class="flex justify-between">
            <button id="back-btn" onclick="goBack()" class="flex-1 mr-2 p-3 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md transition duration-150 hover:bg-gray-300 disabled:opacity-50" disabled>
                <svg class="h-5 w-5 inline-block mr-1 -mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                æˆ»ã‚‹
            </button>

            <button id="next-btn" onclick="goNext()" class="flex-1 ml-2 p-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md transition duration-150 hover:bg-blue-700 disabled:opacity-50" disabled>
                æ¬¡ã¸
                <svg class="h-5 w-5 inline-block ml-1 -mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
            </button>
        </footer>
    </div>

    <script>
        // Google Apps Scriptã®Webã‚¢ãƒ—ãƒªURLã«ç½®ãæ›ãˆã¦ãã ã•ã„
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzh_5SOjjK4drKBGWZhZ71_JOHPz71zIMghEXZWdPAlEgiWhE8MNiAPCB2Y9jQc0Tzb/exec";
        const LIFF_ID = "2006508190-m0e4XMnQ"; // å®Ÿéš›ã®LIFF IDã«ç½®ãæ›ãˆã¦ãã ã•ã„

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let formData = {
            liffId: null, // LIFFãƒ¦ãƒ¼ã‚¶ãƒ¼ID
            displayName: null, // LINEè¡¨ç¤ºå
            reservationMenu: null, // Step 1
            store: null, // Step 2
            reservationDate: null, // Step 3
            reservationTime: null, // Step 4
            fullName: "", // Step 5
            birthDate: null, // Step 5 (YYYYMMDDå½¢å¼)
            phoneNumber: "", // Step 5
            emailAddress: "", // Step 5
            notes: "", // Step 5
            privacyPolicy: false, // Step 5
            gift: null, // Step 6
        };

        let currentStepIndex = 0;

        // **æ”¹å–„ç‚¹2: å‹•çš„ãªã‚¹ãƒ†ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼ç®¡ç†**
        // åŸºæœ¬ã®ã‚¹ãƒ†ãƒƒãƒ—IDã®é…åˆ—
        const BASE_STEP_IDS = ['step-1', 'step-2', 'step-3', 'step-4', 'step-5', 'step-7'];
        let stepFlow = [...BASE_STEP_IDS]; // ç¾åœ¨ã®ãƒ•ãƒ­ãƒ¼

        // ----------------------------------------------------------------------
        // LIFFåˆæœŸåŒ– & èªè¨¼
        // ----------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // äºˆç´„å¯èƒ½ãªæ—¥ä»˜ã®æœ€å°å€¤ã‚’è¨­å®šï¼ˆæœ¬æ—¥ã‚ˆã‚Š2æ—¥å¾Œï¼‰
            const minDate = new Date();
            minDate.setDate(minDate.getDate() + 2);
            document.getElementById('reservationDate').min = minDate.toISOString().split('T')[0];

            initializeBirthDateSelectors(); // **æ”¹å–„ç‚¹1: ç”Ÿå¹´æœˆæ—¥ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®åˆæœŸåŒ–**
            initializeLiff();
            updateStepView(0); // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
        });

        // LIFFã®åˆæœŸåŒ–
        async function initializeLiff() {
            try {
                // LIFF IDãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if (LIFF_ID === "YOUR_LIFF_ID") {
                    document.getElementById('liff-status').textContent = 'LIFF IDã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
                    return;
                }

                await liff.init({
                    liffId: LIFF_ID
                });
                document.getElementById('liff-status').textContent = 'LIFFåˆæœŸåŒ–å®Œäº†';

                if (!liff.isLoggedIn()) {
                    // LIFFç’°å¢ƒå¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚„æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ
                    document.getElementById('liff-status').textContent = 'LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                formData.liffId = profile.userId;
                formData.displayName = profile.displayName;
                document.getElementById('liff-status').textContent = `LIFF IDå–å¾—æ¸ˆ: ${formData.displayName}`;

                // **æ”¹å–„ç‚¹4ã«é–¢é€£: åå‰ã‚’è‡ªå‹•å…¥åŠ›ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸Šæ›¸ãå¯èƒ½ï¼‰**
                const fullNameInput = document.getElementById('fullName');
                if (!fullNameInput.value) {
                    fullNameInput.value = formData.displayName;
                    formData.fullName = formData.displayName;
                }

            } catch (err) {
                console.error('LIFFåˆæœŸåŒ–ã¾ãŸã¯ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—:', err);
                document.getElementById('liff-status').textContent = 'LIFFã‚¨ãƒ©ãƒ¼: è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            }
        }

        // ----------------------------------------------------------------------
        // ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
        // ----------------------------------------------------------------------

        // ã‚¹ãƒ†ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼ã‚’æ›´æ–°
        function updateStepFlow() {
            const menu = formData.reservationMenu;
            const needsGiftStep = menu === 'æŒ¯è¢–ï¼ˆã”è³¼å…¥ï¼‰' || menu === 'æŒ¯è¢–ï¼ˆãƒ¬ãƒ³ã‚¿ãƒ«ï¼‰';

            stepFlow = [...BASE_STEP_IDS];

            // ç‰¹å…¸ã‚¹ãƒ†ãƒƒãƒ—ã‚’æŒ¿å…¥ã™ã‚‹ã‹ã©ã†ã‹
            if (needsGiftStep) {
                const step5Index = stepFlow.indexOf('step-5');
                if (step5Index !== -1 && !stepFlow.includes('step-6')) {
                    // step-5ã®å¾Œã€step-7ã®å‰ã«step-6ã‚’æŒ¿å…¥
                    stepFlow.splice(step5Index + 1, 0, 'step-6');
                }
            } else {
                // ç‰¹å…¸ãŒä¸è¦ãªå ´åˆã¯formDataã‹ã‚‰ã‚¯ãƒªã‚¢
                formData.gift = null;
            }
        }

        // ã‚¹ãƒ†ãƒƒãƒ—ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateStepView(newIndex) {
            const allSteps = ['step-1', 'step-2', 'step-3', 'step-4', 'step-5', 'step-6', 'step-7', 'step-complete', 'step-call'];
            const currentStepId = stepFlow[currentStepIndex];
            const newStepId = stepFlow[newIndex];

            // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’éè¡¨ç¤º
            const currentStepElement = document.getElementById(currentStepId);
            if (currentStepElement) currentStepElement.classList.add('hidden');

            // æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
            const newStepElement = document.getElementById(newStepId);
            if (newStepElement) newStepElement.classList.remove('hidden');

            currentStepIndex = newIndex;

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ›´æ–°
            const totalSteps = stepFlow.length;
            const progress = (currentStepIndex / (totalSteps - 1)) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;

            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.getElementById('back-btn').disabled = currentStepIndex === 0;

            // 'æ¬¡ã¸'ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°ï¼ˆæœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯'ç¢ºèª'ï¼‰
            const nextButton = document.getElementById('next-btn');
            nextButton.textContent = currentStepId === 'step-7' ? 'äºˆç´„ç¢ºå®š' : 'æ¬¡ã¸';

            // å„ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‘¼ã³å‡ºã—ã¦ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹/ç„¡åŠ¹ã«ã™ã‚‹
            validateCurrentStep();

            // ç¢ºèªç”»é¢ (Step 7) ã®å†…å®¹ã‚’å‹•çš„ã«ç”Ÿæˆ
            if (newStepId === 'step-7') {
                generateConfirmationDetails();
            }

            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã¸
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
        function goNext() {
            if (!validateCurrentStep()) {
                showMessage("å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", 'error');
                return;
            }

            // Step 7 ã®å ´åˆã¯æœ€çµ‚é€ä¿¡å‡¦ç†ã¸
            if (stepFlow[currentStepIndex] === 'step-7') {
                submitReservation();
                return;
            }

            // ç‰¹æ®Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ï¼ˆé›»è©±äºˆç´„èª˜å°ï¼‰
            if (stepFlow[currentStepIndex] === 'step-1') {
                const callRequiredMenus = ['å’æ¥­è¢´ï¼ˆä¸€å¼ãƒ¬ãƒ³ã‚¿ãƒ«ï¼‰', 'æŒ¯è¢–ãƒ¬ãƒ³ã‚¿ãƒ«è€…ï¼ˆå’æ¥­è¢´ï¼‰'];
                if (callRequiredMenus.includes(formData.reservationMenu)) {
                    showCallGuidance(formData.reservationMenu);
                    return;
                }
            }

            // **æ”¹å–„ç‚¹2: ã‚¹ãƒ†ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼ã®æ›´æ–°ï¼ˆStep 1ã®æ¬¡ã«å®Ÿè¡Œï¼‰**
            if (stepFlow[currentStepIndex] === 'step-1') {
                updateStepFlow();
            }

            updateStepView(currentStepIndex + 1);
        }

        // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
        function goBack() {
            if (currentStepIndex > 0) {
                updateStepView(currentStepIndex - 1);
            }
        }

        // ----------------------------------------------------------------------
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿å‡¦ç†
        // ----------------------------------------------------------------------

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function updateFormData(key, value) {
            formData[key] = value;

            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯æ›´æ–°
            if (key === 'reservationMenu' || key === 'store' || key === 'gift') {
                document.querySelectorAll(`input[name="${key.toLowerCase()}"]`).forEach(input => {
                    const label = input.nextElementSibling;
                    const icon = label ? label.querySelector('.checked-icon') : null;
                    if (icon) {
                        if (input.checked) {
                            icon.classList.remove('hidden');
                        } else {
                            icon.classList.add('hidden');
                        }
                    }
                });
            }
        }

        // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‘¼ã³å‡ºã—
        function validateCurrentStep() {
            const currentStepId = stepFlow[currentStepIndex];
            switch (currentStepId) {
                case 'step-1':
                    return validateStep1();
                case 'step-2':
                    return validateStep2();
                case 'step-3':
                    return validateStep3();
                case 'step-4':
                    return validateStep4();
                case 'step-5':
                    return validateStep5();
                case 'step-6':
                    return validateStep6();
                case 'step-7':
                    return true; // ç¢ºèªç”»é¢ã¯å¸¸ã«true
                default:
                    return true;
            }
        }

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’åŸºã«æ¬¡ã¸ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function setNextButtonState(isValid) {
            document.getElementById('next-btn').disabled = !isValid;
        }

        // Step 1: ã”äºˆç´„å†…å®¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateStep1() {
            const isValid = !!formData.reservationMenu;
            const errorEl = document.getElementById('step-1-error');
            errorEl.style.display = isValid ? 'none' : 'block';
            setNextButtonState(isValid);
            return isValid;
        }

        // Step 2: åº—èˆ—ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateStep2() {
            const isValid = !!formData.store;
            const errorEl = document.getElementById('step-2-error');
            errorEl.style.display = isValid ? 'none' : 'block';
            setNextButtonState(isValid);
            return isValid;
        }

        // Step 3: æ—¥ä»˜ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateStep3() {
            const isValid = !!formData.reservationDate;
            const errorEl = document.getElementById('step-3-error');
            errorEl.style.display = isValid ? 'none' : 'block';
            setNextButtonState(isValid);

            // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰ã€æ™‚é–“ã®é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
            formData.reservationTime = null;
            document.querySelectorAll('.time-radio').forEach(radio => radio.checked = false);

            return isValid;
        }

        // Step 4: æ™‚é–“ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateStep4() {
            const isValid = !!formData.reservationTime;
            const errorEl = document.getElementById('step-4-error');
            errorEl.style.display = isValid ? 'none' : 'block';
            setNextButtonState(isValid);
            return isValid;
        }

        // Step 5: ãŠå®¢æ§˜æƒ…å ±ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¼·åŒ–ï¼‰
        function validateStep5() {
            let isValid = true;

            // 1. ãŠåå‰
            const fullName = formData.fullName.trim();
            const fullNameEl = document.getElementById('fullName');
            const fullNameErrorEl = document.getElementById('fullName-error');
            if (fullName.length === 0) {
                fullNameEl.classList.add('input-error');
                fullNameErrorEl.style.display = 'block';
                isValid = false;
            } else {
                fullNameEl.classList.remove('input-error');
                fullNameErrorEl.style.display = 'none';
            }

            // 2. ç”Ÿå¹´æœˆæ—¥ (æ”¹å–„å¾Œã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³)
            const birthDateEl = document.getElementById('birthDate');
            const birthDateErrorEl = document.getElementById('birthDate-error');
            if (!formData.birthDate || formData.birthDate.length !== 8) {
                document.getElementById('birthYear').classList.add('input-error');
                document.getElementById('birthMonth').classList.add('input-error');
                document.getElementById('birthDay').classList.add('input-error');
                birthDateErrorEl.style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('birthYear').classList.remove('input-error');
                document.getElementById('birthMonth').classList.remove('input-error');
                document.getElementById('birthDay').classList.remove('input-error');
                birthDateErrorEl.style.display = 'none';
            }

            // 3. é›»è©±ç•ªå·
            const phoneNumber = formData.phoneNumber.trim();
            const phoneNumberEl = document.getElementById('phoneNumber');
            const phoneNumberErrorEl = document.getElementById('phoneNumber-error');
            // ãƒã‚¤ãƒ•ãƒ³ãªã—æ•°å­—10æ¡ã¾ãŸã¯11æ¡ã‚’ãƒã‚§ãƒƒã‚¯
            const phoneRegex = /^\d{10,11}$/;
            if (!phoneRegex.test(phoneNumber)) {
                phoneNumberEl.classList.add('input-error');
                phoneNumberErrorEl.style.display = 'block';
                isValid = false;
            } else {
                phoneNumberEl.classList.remove('input-error');
                phoneNumberErrorEl.style.display = 'none';
            }

            // 4. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼
            const privacyPolicyEl = document.getElementById('privacyPolicy');
            const privacyPolicyErrorEl = document.getElementById('privacyPolicy-error');
            if (!formData.privacyPolicy) {
                privacyPolicyEl.classList.add('input-error');
                privacyPolicyErrorEl.style.display = 'block';
                isValid = false;
            } else {
                privacyPolicyEl.classList.remove('input-error');
                privacyPolicyErrorEl.style.display = 'none';
            }

            setNextButtonState(isValid);
            return isValid;
        }

        // Step 6: ç‰¹å…¸ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateStep6() {
            const isValid = !!formData.gift;
            const errorEl = document.getElementById('step-6-error');
            errorEl.style.display = isValid ? 'none' : 'block';
            setNextButtonState(isValid);
            return isValid;
        }


        // ----------------------------------------------------------------------
        // Step 3 & 4: æ—¥ä»˜ã¨æ™‚é–“
        // ----------------------------------------------------------------------

        // æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã®ç”Ÿæˆ (GASé€£æºãŒãªã„ãŸã‚ã€ã“ã“ã§ã¯å›ºå®šã®ç©ºãæ ã‚’ç”Ÿæˆ)
        function generateTimeSlots() {
            const slotsDiv = document.getElementById('time-slots');
            slotsDiv.innerHTML = '';
            formData.reservationTime = null; // æ—¥ä»˜å¤‰æ›´ã§æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ

            if (!formData.reservationDate) {
                slotsDiv.innerHTML = '<p class="text-gray-500 text-sm col-span-3">ã¾ãšæ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';
                setNextButtonState(false);
                return;
            }

            // 9:00 ã‹ã‚‰ 17:00 ã¾ã§ã€1æ™‚é–“ã”ã¨ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”Ÿæˆ
            const timeSlots = [
                "09:00", "10:00", "11:00", "12:00",
                "13:00", "14:00", "15:00", "16:00", "17:00"
            ];

            // ãƒ€ãƒŸãƒ¼ã®äºˆç´„æ¸ˆã¿æ™‚é–“ï¼ˆä¾‹: 13:00ã¯å¸¸ã«äºˆç´„æ¸ˆã¿ï¼‰
            const bookedSlot = "13:00";

            timeSlots.forEach(time => {
                const isBooked = time === bookedSlot; // å®Ÿéš›ã¯GASã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã§åˆ¤å®š
                const slotId = `time-${time.replace(':', '')}`;

                const div = document.createElement('div');

                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'reservation-time';
                input.id = slotId;
                input.value = time;
                input.classList.add('hidden', 'time-radio');
                input.disabled = isBooked;
                input.onchange = () => {
                    updateFormData('reservationTime', input.value);
                    validateStep4();
                };

                const label = document.createElement('label');
                label.htmlFor = slotId;
                label.classList.add('time-slot-label', 'text-sm');
                label.textContent = time;

                if (isBooked) {
                    label.textContent += ' (æº€)';
                    label.classList.add('opacity-70');
                }

                div.appendChild(input);
                div.appendChild(label);
                slotsDiv.appendChild(div);
            });

            // æ™‚é–“é¸æŠã®ãƒªã‚»ãƒƒãƒˆã«ã‚ˆã‚Šã€æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            setNextButtonState(false);
        }

        // ----------------------------------------------------------------------
        // æ”¹å–„ç‚¹1: ç”Ÿå¹´æœˆæ—¥ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼é–¢é€£
        // ----------------------------------------------------------------------

        function initializeBirthDateSelectors() {
            const yearSelect = document.getElementById('birthYear');
            const monthSelect = document.getElementById('birthMonth');
            const daySelect = document.getElementById('birthDay');

            const currentYear = new Date().getFullYear();
            // å¹´ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ (ä¾‹: ä»Šå¹´ã‹ã‚‰100å¹´å‰ã¾ã§)
            for (let i = currentYear; i >= currentYear - 100; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }

            // æœˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                const monthStr = i.toString().padStart(2, '0');
                option.value = monthStr;
                option.textContent = i;
                monthSelect.appendChild(option);
            }

            // æ—¥ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ (ä¸€æ—¦æœ€å¤§å€¤ã¾ã§ç”Ÿæˆ)
            function updateDayOptions(year, month) {
                // ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’ä¸€æ—¦ã‚¯ãƒªã‚¢
                daySelect.innerHTML = '<option value="">æ—¥</option>';

                if (year && month) {
                    // é¸æŠã•ã‚ŒãŸå¹´ã¨æœˆã®æ—¥æ•°ã‚’è¨ˆç®— (0ã‚’æŒ‡å®šã™ã‚‹ã¨å‰æœˆã®æœ€çµ‚æ—¥)
                    const daysInMonth = new Date(year, month, 0).getDate();
                    for (let i = 1; i <= daysInMonth; i++) {
                        const option = document.createElement('option');
                        const dayStr = i.toString().padStart(2, '0');
                        option.value = dayStr;
                        option.textContent = i;
                        daySelect.appendChild(option);
                    }
                } else {
                    // å¹´æœˆæœªé¸æŠæ™‚ã¯31æ—¥ã¾ã§è¡¨ç¤º
                    for (let i = 1; i <= 31; i++) {
                        const option = document.createElement('option');
                        const dayStr = i.toString().padStart(2, '0');
                        option.value = dayStr;
                        option.textContent = i;
                        daySelect.appendChild(option);
                    }
                }
            }

            // ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼å¤‰æ›´æ™‚ã«æ—¥ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
            yearSelect.onchange = () => {
                updateDayOptions(yearSelect.value, monthSelect.value);
                updateBirthDate();
                validateStep5();
            };
            monthSelect.onchange = () => {
                updateDayOptions(yearSelect.value, monthSelect.value);
                updateBirthDate();
                validateStep5();
            };
            // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚å‘¼ã³å‡ºã—
            updateDayOptions(null, null);
        }

        // å¹´æœˆæ—¥ã‹ã‚‰formDataã®birthDate(YYYYMMDD)ã‚’æ›´æ–°
        function updateBirthDate() {
            const year = document.getElementById('birthYear').value;
            const month = document.getElementById('birthMonth').value;
            const day = document.getElementById('birthDay').value;
            const birthDateInput = document.getElementById('birthDate');

            if (year && month && day) {
                // YYYYMMDDå½¢å¼ã§æ ¼ç´
                const dateStr = `${year}${month}${day}`;
                formData.birthDate = dateStr;
                birthDateInput.value = dateStr;
            } else {
                formData.birthDate = null;
                birthDateInput.value = '';
            }
            // hidden input ã® onchangeã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¦ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
            birthDateInput.dispatchEvent(new Event('change'));
        }

        // ----------------------------------------------------------------------
        // ç¢ºèªç”»é¢ (Step 7) ã®ç”Ÿæˆ
        // ----------------------------------------------------------------------

        function generateConfirmationDetails() {
            const container = document.getElementById('confirmation-details');
            container.innerHTML = '';

            const items = [{
                    label: 'ã”äºˆç´„å†…å®¹',
                    value: formData.reservationMenu,
                    required: true
                },
                {
                    label: 'ã”å¸Œæœ›åº—èˆ—',
                    value: formData.store,
                    required: true
                },
                {
                    label: 'ã”äºˆç´„æ—¥ä»˜',
                    value: formData.reservationDate,
                    required: true
                },
                {
                    label: 'ã”äºˆç´„æ™‚é–“',
                    value: formData.reservationTime,
                    required: true
                },
                {
                    label: 'ãŠåå‰',
                    value: formData.fullName,
                    required: true
                },
                {
                    label: 'ç”Ÿå¹´æœˆæ—¥',
                    value: formatDateToJapanese(formData.birthDate),
                    required: true
                },
                {
                    label: 'é›»è©±ç•ªå·',
                    value: formData.phoneNumber,
                    required: true
                },
                {
                    label: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
                    value: formData.emailAddress || '(ãªã—)',
                    required: false
                },
                {
                    label: 'å‚™è€ƒæ¬„',
                    value: formData.notes || '(ãªã—)',
                    required: false
                },
                {
                    label: 'ã”æ¥åº—ç‰¹å…¸',
                    value: formData.gift || '(è©²å½“ãªã—/å¸Œæœ›ã—ãªã„)',
                    required: false,
                    condition: formData.reservationMenu === 'æŒ¯è¢–ï¼ˆã”è³¼å…¥ï¼‰' || formData.reservationMenu === 'æŒ¯è¢–ï¼ˆãƒ¬ãƒ³ã‚¿ãƒ«ï¼‰'
                },
            ];

            items.forEach(item => {
                // ç‰¹å…¸ã‚¹ãƒ†ãƒƒãƒ—ãŒä¸è¦ãªå ´åˆã€ç‰¹å…¸ã¯è¡¨ç¤ºã—ãªã„
                if (item.condition === false) return;
                if (!item.required && !item.value) return; // ä»»æ„é …ç›®ã§å€¤ãŒãªã„å ´åˆã¯è¡¨ç¤ºã—ãªã„

                const div = document.createElement('div');
                div.classList.add('flex', 'justify-between', 'border-b', 'pb-2');
                div.innerHTML = `
                    <span class="text-sm font-medium text-gray-500">${item.label}</span>
                    <span class="text-sm font-semibold text-gray-800 text-right">${item.value}</span>
                `;
                container.appendChild(div);
            });

            // ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼åŒæ„ã®è¡¨ç¤º
            const consentDiv = document.createElement('div');
            consentDiv.classList.add('mt-4', 'p-3', 'text-center', 'rounded-lg', 'font-medium', formData.privacyPolicy ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700');
            consentDiv.textContent = formData.privacyPolicy ? 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„æ¸ˆã¿' : 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®åŒæ„ãŒã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼';
            container.appendChild(consentDiv);
        }

        // æ—¥ä»˜ã‚’YYYY/MM/DDå½¢å¼ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function formatDateToJapanese(dateStr) {
            if (!dateStr || dateStr.length !== 8) return 'æœªå…¥åŠ›';
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${year}å¹´${parseInt(month, 10)}æœˆ${parseInt(day, 10)}æ—¥`;
        }


        // ----------------------------------------------------------------------
        // GASé€ä¿¡ã¨å®Œäº†å‡¦ç†
        // ----------------------------------------------------------------------

        function submitReservation() {
            // UIã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
            const nextButton = document.getElementById('next-btn');
            const originalText = nextButton.textContent;
            nextButton.textContent = 'é€ä¿¡ä¸­...';
            nextButton.disabled = true;

            const url = GAS_WEB_APP_URL + '?action=reserve';

            // FormDataã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›
            const postData = JSON.stringify(formData);

            fetch(url, {
                    method: 'POST',
                    mode: 'no-cors', // GASã¨ã®é€£æºã§ã¯no-corsãŒå¿…è¦ãªå ´åˆãŒå¤šã„
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: postData,
                })
                .then(response => {
                    // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã‚’ç¢ºèªã§ããªã„ãŸã‚ã€æˆåŠŸã¨è¦‹ãªã™
                    // å®Ÿéš›ã«ã¯GASå´ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œã®URLã«äºˆç´„IDã‚’å«ã‚ã¦æˆåŠŸã•ã›ã‚‹æ–¹ãŒæœ›ã¾ã—ã„
                    console.log("GASã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº† (no-corsãƒ¢ãƒ¼ãƒ‰)");
                    handleGASResponse({
                        status: 'success',
                        reservationId: 'R' + Date.now()
                    });
                })
                .catch(error => {
                    console.error('GASé€£æºã‚¨ãƒ©ãƒ¼:', error);
                    showMessage('äºˆç´„é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç©ºã‘ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');

                    // UIã‚’å…ƒã«æˆ»ã™
                    nextButton.textContent = originalText;
                    nextButton.disabled = false;
                });
        }


        // GASå¿œç­”å¾Œã®å‡¦ç†
        async function handleGASResponse(data) {
            if (data.status !== 'success') {
                showMessage(`äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, 'error');
                return;
            }

            // LIFFãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
            try {
                if (liff.isInClient() && liff.isApiAvailable('shareTargetPicker')) {
                    // LIFFãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰
                    const messageText = `ã€æ¥åº—äºˆç´„å®Œäº†ã€‘\n\nâ—†ã”äºˆç´„å†…å®¹ï¼š${formData.reservationMenu}\nâ—†åº—èˆ—ï¼š${formData.store}\nâ—†æ—¥æ™‚ï¼š${formData.reservationDate} ${formData.reservationTime}\nâ—†ãŠåå‰ï¼š${formData.fullName}\n\nã“ã®åº¦ã¯ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚`;

                    await liff.shareTargetPicker([{
                        type: 'text',
                        text: messageText
                    }], {
                        isPublic: true // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãªã©ã«æŠ•ç¨¿ã§ãã‚‹è¨­å®š
                    });

                    console.log("LIFFãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æˆåŠŸ (ShareTargetPicker)");
                }
            } catch (liffError) {
                console.error("LIFFãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:", liffError);
                // LIFFãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®å¤±æ•—ã¯äºˆç´„å¤±æ•—ã¨ã¯ã—ãªã„
            }

            // å®Œäº†ç”»é¢UIã®æ›´æ–°
            document.getElementById('footer-nav').classList.add('hidden');
            document.getElementById('step-7').classList.add('hidden');
            document.getElementById('step-complete').classList.remove('hidden');

            if (data.reservationId) {
                const msgBox = document.getElementById('complete-message');
                msgBox.textContent = `äºˆç´„ç•ªå·: ${data.reservationId}`;
                msgBox.classList.remove('hidden');
            }

            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã¸
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }


        // é›»è©±äºˆç´„èª˜å°ç”»é¢ã®è¡¨ç¤º
        function showCallGuidance(menuName) {
            document.getElementById(stepFlow[currentStepIndex]).classList.add('hidden'); // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’éš ã™
            document.getElementById('step-call').classList.remove('hidden'); // é›»è©±èª˜å°ç”»é¢ã‚’è¡¨ç¤º
            document.getElementById('call-menu-name').textContent = menuName;
            document.getElementById('footer-nav').classList.add('hidden'); // ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éš ã™
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function showMessage(msg, type) {
            const area = document.getElementById('message-area');
            area.textContent = msg;
            area.className = `mb-4 p-3 rounded-lg text-sm text-center font-medium shadow-sm ${type === 'error' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`;
            area.classList.remove('hidden');
            area.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

    </script>
</body>

</html>
